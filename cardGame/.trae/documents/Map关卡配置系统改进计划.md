# Map关卡配置系统改进计划

## 当前实现分析
1. **已支持的功能**：
   - 手动节点摆放（通过MapLayoutSO的nodePositions列表）
   - 节点类型配置（战斗、精英、Boss、事件、商店、休息、挖掘场）
   - 节点属性设置（起始节点、Boss节点、精英节点标记）
   - 程序化和手动两种生成模式
   - 节点完成后解锁下游节点的逻辑

2. **需要改进的功能**：
   - 明确的层级划分机制
   - 每层只能选择一个节点的限制
   - 从dig场景返回后同层不可再选，节点向后推进一层
   - 层级推进后的节点状态管理

## 改进计划

### 1. 增强MapLayoutSO的数据结构
- **添加层级属性**：为ManualNodePosition添加layerIndex属性，明确节点所属层级
- **层级配置**：在MapLayoutSO中添加层级相关配置选项

### 2. 改进MapGenerator.cs
- **手动模式层级处理**：在GenerateManualMap方法中支持基于layerIndex的层级管理
- **节点连接优化**：确保节点主要连接到下一层级的节点，避免跨多层级连接

### 3. 增强MapManager.cs
- **层级推进逻辑**：实现从dig场景返回后，同层不可再选，地图节点向后推进一层
- **节点选择限制**：添加逻辑确保每层只能选择一个节点进行挑战
- **层级状态管理**：维护各层级的完成状态，确保已完成层级的节点不可再选

### 4. 优化NodeInteractionManager.cs
- **节点交互验证**：增强节点交互验证逻辑，考虑层级限制
- **层级推进触发**：在节点完成后触发层级推进逻辑

### 5. 改进MapNodeData.cs
- **添加层级属性**：为MapNodeData添加layerIndex属性，记录节点所属层级
- **层级状态标记**：添加层级完成状态标记

## 实现步骤

1. **修改数据结构**：
   - 更新MapLayoutSO.cs，添加层级相关属性
   - 更新MapNodeData.cs，添加层级属性

2. **改进地图生成逻辑**：
   - 修改MapGenerator.cs，支持基于层级的节点生成和连接

3. **实现层级管理逻辑**：
   - 修改MapManager.cs，添加层级推进和节点选择限制逻辑

4. **增强节点交互验证**：
   - 修改NodeInteractionManager.cs，添加层级相关的交互验证

5. **测试和调试**：
   - 测试手动配置关卡的层级管理
   - 测试每层只能选择一个节点的限制
   - 测试从dig场景返回后的层级推进

## 预期效果
1. **明确的层级划分**：每个节点都属于特定层级，层级关系清晰
2. **每层只能选择一个节点**：玩家在每个层级只能选择一个节点进行挑战
3. **层级推进机制**：完成当前层级的节点后，自动推进到下一层级
4. **dig场景返回处理**：从dig场景返回后，同层不可再选，节点向后推进一层
5. **良好的扩展性**：支持后续添加更多层级相关的功能

通过以上改进，我们将实现一个功能完整、逻辑清晰的Map关卡配置系统，满足用户的所有需求。