# 挖掘系统知识库

## 模块概述
挖掘系统是一个完整的挖掘系统，支持网格挖掘、化石收集、物品飞行动画、粒子效果等功能。

## 核心功能
- 网格挖掘
- 化石收集
- 物品飞行动画
- 粒子效果
- 震动反馈

## 核心文件和类

### 1. DigInputHandler.cs
- **位置**: `Assets/Dig/DigInputHandler.cs`
- **功能**: 处理用户输入，将鼠标点击转换为网格坐标并调用挖掘逻辑
- **主要功能**:
  - 鼠标输入处理
  - 坐标转换
  - 挖掘调用

### 2. GridManager.cs
- **位置**: `Assets/Dig/GridManager.cs`
- **功能**: 核心网格管理器，负责地图生成、化石放置、挖掘逻辑、视觉反馈等
- **主要功能**:
  - 地图生成
  - 化石放置
  - 挖掘逻辑
  - 视觉反馈
  - 物品飞行动画

### 3. TileView.cs
- **位置**: `Assets/Dig/TileView.cs`
- **功能**: 地块视觉显示，负责单个地块的视觉效果
- **主要功能**:
  - 地块视觉显示
  - 边缘效果
  - 受损效果

### 4. FossilData.cs
- **位置**: `Assets/Dig/FossilData.cs`
- **功能**: 化石数据定义，包含化石的基本属性、形状、奖励等
- **主要功能**:
  - 化石属性定义
  - 形状定义
  - 奖励定义

### 5. TreasureVisual.cs
- **位置**: `Assets/Dig/TreasureVisual.cs`
- **功能**: 宝藏视觉效果，负责化石的视觉显示
- **主要功能**:
  - 化石视觉显示
  - 完成动画

## 关键API和方法

### DigInputHandler
- `Update()`: 处理鼠标输入

### GridManager
- `Dig(Vector2Int pos, int damage)`: 挖掘指定位置
- `PlantFossil(FossilData data)`: 放置化石
- `GenerateLevel()`: 生成关卡
- `StartFlyingEffect(Sprite iconSprite, Vector3 startWorldPos, Bag.ItemData itemData)`: 开始飞行动画

### TileView
- `UpdateEdgeVisuals(bool top, bool bottom, bool left, bool right)`: 更新边缘视觉效果
- `OnHit(float hpPercent)`: 受到伤害时的效果
- `HideAllEdges()`: 隐藏所有边缘

### FossilData
- **属性**: fossilName, fossilSprite, shapeOffsets, rewardItem

### TreasureVisual
- `SetData(Sprite sprite, Vector3 worldPos, int rotationSteps)`: 设置数据
- `OnComplete()`: 完成时的效果

## 使用示例

### 1. 挖掘地块
```csharp
// 挖掘指定位置
gridManager.Dig(new Vector2Int(x, y), 1);
```

### 2. 放置化石
```csharp
// 放置化石
gridManager.PlantFossil(fossilData);
```

### 3. 开始飞行动画
```csharp
// 开始飞行动画
gridManager.StartFlyingEffect(iconSprite, startWorldPos, itemData);
```

## 配置和依赖
- **地图设置**: 需要设置地图宽度、高度
- **地块预制体**: 需要设置地块预制体
- **化石数据**: 需要设置化石数据列表
- **飞行动画**: 需要设置飞行动画预制体
- **粒子效果**: 需要设置挖掘粒子效果

## 常见问题和解决方案

### 1. 挖掘后地块不显示
**原因**: 地块视觉更新逻辑未执行
**解决方案**: 检查UpdateTileVisual方法的执行

### 2. 化石不生成
**原因**: 化石数据列表为空或放置逻辑失败
**解决方案**: 检查化石数据配置，确保放置逻辑正确

### 3. 飞行动画不播放
**原因**: 飞行动画预制体未设置或坐标转换失败
**解决方案**: 检查飞行动画预制体配置，确保坐标转换正确

## 扩展建议
- 添加不同类型的地块
- 实现更复杂的化石形状
- 添加挖掘工具系统
- 实现挖掘等级和技能