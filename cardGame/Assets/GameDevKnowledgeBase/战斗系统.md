# 战斗系统知识库

## 模块概述
战斗系统是一个完整的回合制战斗系统，支持回合管理、卡牌打出、敌人AI协调、战斗胜利/失败处理等功能。

## 核心功能
- 回合管理（玩家回合、敌人回合）
- 卡牌打出和效果执行
- 敌人AI和意图系统
- 战斗胜利/失败处理
- 战斗动画和视觉效果
- 角色状态管理

## 核心文件和类

### 1. BattleManager.cs
- **位置**: `Assets/CS/Managers/BattleManager.cs`
- **功能**: 战斗系统核心管理器，负责回合管理、卡牌打出、敌人AI协调等
- **主要功能**:
  - 回合管理
  - 卡牌打出
  - 敌人AI协调
  - 战斗胜利/失败处理

### 2. CharacterManager.cs
- **位置**: `Assets/CS/Managers/CharacterManager.cs`
- **功能**: 角色管理器，负责管理战斗中的所有角色
- **主要功能**:
  - 角色注册和管理
  - 获取活跃角色
  - 角色状态更新

### 3. BattleVisualizer.cs
- **位置**: `Assets/CS/Managers/BattleVisualizer.cs`
- **功能**: 战斗视觉效果管理器，负责卡牌动画、布局等
- **主要功能**:
  - 卡牌布局
  - 卡牌动画
  - 视觉效果

### 4. EnemyAI.cs
- **位置**: `Assets/CS/动画控制/EnemyAI.cs`
- **功能**: 敌人AI，负责敌人的意图计算和行动执行
- **主要功能**:
  - 意图计算
  - 行动执行
  - 策略选择

### 5. CharacterBase.cs
- **位置**: `Assets/CS/对战AI/Entities（结果）/CharacterBase.cs`
- **功能**: 角色基类，包含角色的基本属性和方法
- **主要功能**:
  - 角色属性管理
  - 伤害处理
  - 状态效果管理

## 关键API和方法

### BattleManager
- `StartPlayerTurn()`: 开始玩家回合
- `EndPlayerTurn()`: 结束玩家回合
- `StartEnemyTurn()`: 开始敌人回合
- `TryPlayCard(CardDisplay cardDisplay, CharacterBase target)`: 尝试打出卡牌
- `CheckBattleEnd()`: 检查战斗是否结束
- `EndBattle(bool isVictory)`: 结束战斗

### CharacterManager
- `GetActiveHero()`: 获取活跃的英雄
- `GetAllEnemies()`: 获取所有敌人
- `GetAllHeroes()`: 获取所有英雄
- `RegisterCharacter(CharacterBase character)`: 注册角色
- `UnregisterCharacter(CharacterBase character)`: 注销角色

### EnemyAI
- `CalculateIntent(CharacterBase hero, int currentRound)`: 计算敌人意图
- `PerformAction(CharacterBase hero, int currentRound)`: 执行敌人行动

### CharacterBase
- `TakeDamage(int damage, bool showDamagePopup)`: 受到伤害
- `AddBlock(int amount)`: 添加格挡
- `Heal(int amount)`: 治疗
- `ApplyStatusEffect(string effectName, int amount, int duration)`: 应用状态效果

## 使用示例

### 1. 开始战斗
```csharp
// 初始化战斗
BattleManager.Instance.InitializeBattle(encounterData);

// 开始战斗
BattleManager.Instance.StartBattle();
```

### 2. 打出卡牌
```csharp
// 尝试打出卡牌
BattleManager.Instance.TryPlayCard(cardDisplay, targetCharacter);
```

### 3. 结束战斗
```csharp
// 检查战斗是否结束
BattleManager.Instance.CheckBattleEnd();

// 结束战斗
BattleManager.Instance.EndBattle(isVictory);
```

## 配置和依赖
- **卡牌预制体**: 需要设置卡牌显示预制体
- **角色预制体**: 需要设置英雄和敌人预制体
- **敌人AI策略**: 需要设置敌人AI策略
- **战斗UI**: 需要设置战斗UI组件

## 常见问题和解决方案

### 1. 战斗卡顿
**原因**: 动画序列执行过慢或逻辑处理过于复杂
**解决方案**: 优化动画序列，减少每帧处理的逻辑量

### 2. 敌人不行动
**原因**: EnemyAI组件未正确设置或策略选择失败
**解决方案**: 检查EnemyAI组件的设置，确保策略选择逻辑正确

### 3. 战斗结束后不跳转场景
**原因**: 战斗结束逻辑未正确执行或场景跳转逻辑有问题
**解决方案**: 检查EndBattle方法的执行，确保场景跳转逻辑正确

## 扩展建议
- 添加更多敌人AI策略
- 实现更复杂的状态效果系统
- 添加战斗环境和场景互动
- 实现战斗记录和回放系统