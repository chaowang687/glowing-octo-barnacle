# 背包系统知识库

## 模块概述
背包系统是一个功能完整的物品管理系统，支持异形物品、360度旋转、自动寻找空位、星星连接高亮等高级功能。

## 核心功能
- 物品拖拽和放置
- 异形物品支持（不同大小和形状）
- 物品360度旋转
- 自动寻找空位放置物品
- 星星连接高亮系统
- 物品保存和加载
- 背包与全局数据同步
- 回合开始遗物效果触发

## 核心文件和类

### 1. InventoryManager.cs
- **位置**: `Assets/Bag/InventoryManager.cs`
- **功能**: 背包系统核心管理器，负责协调各个背包组件之间的交互
- **主要功能**:
  - 物品的添加、移除、保存/加载
  - 拖拽管理
  - 物品旋转
  - 自动寻找空位
  - 与GameDataManager同步

### 2. ItemUI.cs
- **位置**: `Assets/Bag/ItemUI.cs`
- **功能**: 单个物品的显示和交互组件
- **主要功能**:
  - 物品视觉显示
  - 拖拽逻辑
  - 旋转逻辑
  - 星星图标生成和高亮
  - 外发光效果

### 3. InventoryGrid.cs
- **位置**: `Assets/Bag/InventoryGrid.cs`
- **功能**: 背包网格管理，负责物品在网格中的占位和碰撞检测

### 4. ItemData.cs
- **位置**: `Assets/Bag/ItemData.cs`
- **功能**: 物品数据定义，包含物品的基本属性、形状、效果等

### 5. ItemInstance.cs
- **位置**: `Assets/Bag/ItemInstance.cs`
- **功能**: 物品实例，包含物品的当前状态（位置、旋转等）

## 关键API和方法

### InventoryManager
- `SpawnItem(ItemData itemData, Vector2Int gridPos, bool autoFindSpace)`: 在指定位置生成物品
- `SpawnItemAtMouse(ItemData itemData)`: 在鼠标位置生成物品并进入拖拽状态
- `FindEmptySpace(InventoryGrid grid, ItemData itemData)`: 寻找网格中的空位
- `TryRotateItem(ItemUI ui)`: 尝试旋转物品
- `DropItem(ItemUI ui)`: 丢弃物品
- `TriggerTurnStartRelics()`: 触发回合开始遗物效果

### ItemUI
- `Initialize(ItemInstance item, float cellSize)`: 初始化物品UI
- `DoVisualRotate()`: 执行视觉旋转
- `UpdateStarHighlight()`: 更新星星高亮状态
- `ShowGlow()`: 显示外发光效果

## 使用示例

### 1. 生成物品
```csharp
// 在指定位置生成物品
InventoryManager.Instance.SpawnItem(itemData, new Vector2Int(0, 0), true);

// 在鼠标位置生成物品
InventoryManager.Instance.SpawnItemAtMouse(itemData);
```

### 2. 旋转物品
```csharp
// 尝试旋转物品
InventoryManager.Instance.TryRotateItem(itemUI);
```

### 3. 丢弃物品
```csharp
// 丢弃物品
InventoryManager.Instance.DropItem(itemUI);
```

## 配置和依赖
- **物品预制体**: 需要设置物品UI预制体
- **网格设置**: 需要配置InventoryGrid的宽度、高度和单元格大小
- **星星预制体**: 需要设置星星图标预制体
- **GameDataManager**: 用于全局数据同步

## 常见问题和解决方案

### 1. 物品旋转后无法放置
**原因**: 旋转后物品形状变化，可能与其他物品碰撞
**解决方案**: 使用`FindEmptySpace`方法自动寻找合适的位置

### 2. 星星高亮不显示
**原因**: 星星偏移设置不正确或星星预制体未设置
**解决方案**: 检查ItemData中的starOffsets设置，并确保starPrefab已赋值

### 3. 物品保存后加载失败
**原因**: 物品ID与Resources.Load路径不匹配
**解决方案**: 确保物品ID与Resources文件夹中的文件名一致

## 扩展建议
- 添加物品合成系统
- 实现物品分类和搜索功能
- 添加物品使用效果系统
- 实现背包扩容功能