# 地图系统知识库

## 模块概述
地图系统是一个完整的地图管理系统，支持地图生成、节点管理、场景跳转、进度保存等功能。

## 核心功能
- 地图生成和管理
- 节点管理（解锁、完成、当前节点）
- 场景跳转
- 进度保存和加载
- 节点交互

## 核心文件和类

### 1. MapManager.cs
- **位置**: `Assets/Map/逻辑层/MapManager.cs`
- **功能**: 地图系统核心管理器，负责地图生成、节点管理、场景跳转等
- **主要功能**:
  - 地图生成
  - 节点管理
  - 场景跳转
  - 进度保存和加载

### 2. MapGenerator.cs
- **位置**: `Assets/Map/逻辑层/MapGenerator.cs`
- **功能**: 地图生成器，负责根据配置生成地图节点
- **主要功能**:
  - 地图节点生成
  - 连接关系创建
  - 节点类型分配

### 3. PlayerStateManager.cs
- **位置**: `Assets/Map/逻辑层/PlayerStateManager.cs`
- **功能**: 玩家状态管理器，负责管理玩家的状态
- **主要功能**:
  - 玩家状态管理
  - 状态保存和加载

### 4. NodeInteractionManager.cs
- **位置**: `Assets/Map/逻辑层/NodeInteractionManager.cs`
- **功能**: 节点交互管理器，负责处理节点的点击和交互
- **主要功能**:
  - 节点点击处理
  - 交互逻辑

### 5. SaveLoadManager.cs
- **位置**: `Assets/Map/逻辑层/SaveLoadManager.cs`
- **功能**: 保存加载管理器，负责保存和加载游戏进度
- **主要功能**:
  - 进度保存
  - 进度加载

### 6. MapUI.cs
- **位置**: `Assets/Map/表现层/MapUI.cs`
- **功能**: 地图UI，负责地图的视觉显示
- **主要功能**:
  - 地图视觉显示
  - 节点UI生成
  - 交互反馈

## 关键API和方法

### MapManager
- `GenerateMapOnce()`: 生成地图（仅一次）
- `LoadFromGameDataManagerDirectly()`: 从GameDataManager直接加载数据
- `CompleteNode(MapNodeData node)`: 完成节点
- `IsNodeInteractable(MapNodeData node)`: 判断节点是否可交互
- `EnterSelectedNode(MapNodeData node)`: 进入选中的节点

### MapGenerator
- `GenerateMap(MapLayoutSO layout)`: 根据配置生成地图
- `FindStartNode(MapNodeData[] nodes)`: 找到起始节点

### PlayerStateManager
- `GetPlayerState()`: 获取玩家状态
- `LoadPlayerState(PlayerState state)`: 加载玩家状态

### NodeInteractionManager
- `OnNodeClicked(MapNodeData node, MapManager manager)`: 处理节点点击

### SaveLoadManager
- `SaveGameProgress(PlayerStateManager playerState, MapNodeData currentNode, MapNodeData[] allNodes, bool useGameDataManager)`: 保存游戏进度
- `LoadPlayerProgress(PlayerStateManager playerState, ref MapNodeData currentNode, MapNodeData[] allNodes)`: 加载玩家进度

## 使用示例

### 1. 生成地图
```csharp
// 生成地图
MapManager.Instance.GenerateMapOnce();
```

### 2. 完成节点
```csharp
// 完成当前节点
MapManager.Instance.CompleteCurrentNode();

// 完成指定节点
MapManager.Instance.CompleteNode(node);
```

### 3. 进入节点
```csharp
// 进入选中的节点
MapManager.Instance.OnContinueButtonClicked();

// 进入指定节点
MapManager.Instance.EnterSelectedNode(node);
```

## 配置和依赖
- **地图布局配置**: 需要设置MapLayoutSO
- **节点预制体**: 需要设置节点UI预制体
- **GameDataManager**: 用于全局数据同步

## 常见问题和解决方案

### 1. 地图节点不显示
**原因**: 地图生成失败或UI生成失败
**解决方案**: 检查MapLayoutSO配置，确保节点预制体正确设置

### 2. 场景跳转失败
**原因**: 场景名称不正确或节点数据不完整
**解决方案**: 检查场景名称，确保节点数据包含正确的encounterData

### 3. 进度保存失败
**原因**: GameDataManager未初始化或数据格式错误
**解决方案**: 确保GameDataManager正确初始化，检查数据格式

## 扩展建议
- 添加更多节点类型
- 实现更复杂的地图生成算法
- 添加地图事件和随机事件
- 实现地图探索奖励系统